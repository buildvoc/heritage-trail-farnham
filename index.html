<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Deck.gl — Building Footprints (Red–Yellow–Green Scale + OSM)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Deck.gl -->
  <link rel="stylesheet" href="https://unpkg.com/deck.gl@9.2.0/dist/stylesheet.css">
  <script src="https://unpkg.com/deck.gl@9.2.0/dist.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: #0b1120;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    #map { position: absolute; inset: 0; }

    .info-card {
      position: absolute;
      top: 16px;
      left: 16px;
      max-width: 340px;
      padding: 14px 16px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      font-size: 13px;
      color: #111827;
      z-index: 10;
      border: 1px solid #e5e7eb;
    }

    .info-card h2 {
      margin: 0 0 4px;
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }

    .info-card p {
      margin: 4px 0 10px;
      font-size: 13px;
      color: #374151;
    }

    /* Legend */
    .legend {
      margin: 8px 0 12px;
    }

    .legend-gradient {
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(
        to right,
        #006d6f,
        #b2e2bd,
        #ffffcc,
        #fed976,
        #fd8d3c,
        #f03b20,
        #bd0026
      );
    }

    .legend-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 11px;
      color: #374151;
      font-weight: 500;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      gap: 14px;
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
    }

    .stat-label {
      font-size: 10px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: #f59e0b;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="info-card">
    <h2>Building Footprints (Heights)</h2>
    <p>OSM basemap — Red → Yellow → Green scale (<strong>&lt; 18 m = dark red (60%)</strong>).</p>

    <div class="legend">
      <div class="legend-gradient"></div>
      <div class="legend-labels">
        <span>0 m</span><span>15 m</span><span>30 m+</span>
      </div>
    </div>

    <div class="stats">
      <div>
        <div class="stat-label">NO. OF POLYGONS</div>
        <div class="stat-value" id="stat-polygons">–</div>
      </div>
      <div>
        <div class="stat-label">NO. OF VERTICES</div>
        <div class="stat-value" id="stat-vertices">–</div>
      </div>
    </div>
  </div>

  <script>
    const {Deck, MapView, GeoJsonLayer, TileLayer, BitmapLayer} = deck;

    const GEOJSON_FILES = [
      "part-00012-leicester-city-centre-outer-ring-road.geojson"
    ];

    // Diverging color scale (blue-green-yellow-orange-red)
    const DIVERGING_SCALE = [
      [0, 109, 111],
      [178, 226, 189],
      [255, 255, 204],
      [254, 217, 118],
      [253, 141, 60],
      [240, 59, 32],
      [189, 0, 38]
    ];

    const MAX_HEIGHT = 30;
    const THRESHOLD = 18;
    const THRESHOLD_FACTOR = 0.6;

    function interpolateColor(scale, t) {
      const n = scale.length - 1;
      const tt = Math.max(0, Math.min(1, t));
      const i = Math.floor(tt * n);
      const frac = tt * n - i;
      const c1 = scale[i];
      const c2 = scale[Math.min(i + 1, n)];
      return [
        Math.round(c1[0] + (c2[0] - c1[0]) * frac),
        Math.round(c1[1] + (c2[1] - c1[1]) * frac),
        Math.round(c1[2] + (c2[2] - c1[2]) * frac)
      ];
    }

    function countVertices(coords) {
      if (!Array.isArray(coords)) return 0;
      if (coords.length >= 2 && typeof coords[0] === "number") return 1;
      return coords.reduce((sum, c) => sum + countVertices(c), 0);
    }

    function getBounds(geojson) {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      function walk(coords) {
        if (!Array.isArray(coords)) return;
        if (typeof coords[0] === "number" && typeof coords[1] === "number") {
          const [x, y] = coords;
          if (x < minX) minX = x;
          if (x > maxX) maxX = x;
          if (y < minY) minY = y;
          if (y > maxY) maxY = y;
        } else coords.forEach(walk);
      }
      geojson.features.forEach(f => walk(f.geometry.coordinates));
      return {minX, minY, maxX, maxY};
    }

    async function loadAllGeoJSON() {
      const allFeatures = [];
      for (const file of GEOJSON_FILES) {
        try {
          const res = await fetch(file);
          const data = await res.json();
          if (data.features) allFeatures.push(...data.features);
        } catch (err) {
          console.error(`Failed to load ${file}:`, err);
        }
      }
      return {type: "FeatureCollection", features: allFeatures};
    }

    async function main() {
      const geojson = await loadAllGeoJSON();
      if (!geojson.features.length) {
        alert("No features loaded.");
        return;
      }

      let vertexCount = 0;
      for (const f of geojson.features)
        if (f.geometry) vertexCount += countVertices(f.geometry.coordinates);
      document.getElementById("stat-polygons").textContent =
        geojson.features.length.toLocaleString();
      document.getElementById("stat-vertices").textContent =
        vertexCount.toLocaleString();

      const {minX, minY, maxX, maxY} = getBounds(geojson);
      const center = [(minX + maxX) / 2, (minY + maxY) / 2];
      const bboxWidth = Math.abs(maxX - minX);
      const zoom = Math.max(10, Math.min(20, Math.log2(360 / bboxWidth) + 1));

      const osmBasemap = new TileLayer({
        id: "osm-basemap",
        data: "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        minZoom: 0,
        maxZoom: 19,
        tileSize: 256,
        renderSubLayers: props => {
          const {bbox: {west, south, east, north}} = props.tile;
          return new BitmapLayer(props, {
            data: null,
            image: props.data,
            bounds: [west, south, east, north]
          });
        }
      });

      const buildingsLayer = new GeoJsonLayer({
        id: "buildings",
        data: geojson,
        extruded: true,
        wireframe: false,
        filled: true,
        getElevation: f => Math.max(f.properties?.height || 0, 0) * 4,
        getFillColor: f => {
          const h = f.properties?.height || 0;
          const clamped = Math.max(0, Math.min(h, MAX_HEIGHT));
          let t;
          if (clamped < THRESHOLD)
            t = (clamped / THRESHOLD) * THRESHOLD_FACTOR;
          else
            t =
              THRESHOLD_FACTOR +
              ((clamped - THRESHOLD) / (MAX_HEIGHT - THRESHOLD)) *
                (1 - THRESHOLD_FACTOR);
          return interpolateColor(DIVERGING_SCALE, t);
        },
        pickable: true,
        getLineColor: [30, 40, 50],
        lineWidthMinPixels: 1
      });

      new Deck({
        container: "map",
        views: [new MapView({repeat: true})],
        initialViewState: {
          longitude: center[0],
          latitude: center[1],
          zoom: zoom,
          pitch: 45,
          bearing: 0
        },
        controller: true,
        layers: [osmBasemap, buildingsLayer],
        getTooltip: ({object}) =>
          object && `Height: ${object.properties.height?.toFixed(2)} m`
      });
    }

    main();
  </script>
</body>
</html>
