<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>deck.gl PolygonLayer Example</title>
    <link
      rel="stylesheet"
      href="vendor/deck.gl-widgets@9.2.2/deck.gl-widgets.min.css"
    />
    <style>
      :root {
        color-scheme: dark;
      }

      html,
      body {
        margin: 0;
        height: 100%;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        background: #020617;
        color: #f8fafc;
      }

      #app {
        position: relative;
        height: 100%;
      }

      #deck-canvas {
        position: absolute;
        inset: 0;
      }

      #control-panel {
        position: absolute;
        top: 16px;
        left: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px 18px;
        max-width: min(320px, 80vw);
        border-radius: 12px;
        background: rgba(2, 6, 23, 0.78);
        backdrop-filter: blur(6px);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.4);
        z-index: 10;
      }

      #control-panel h1 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      #control-panel p {
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.4;
        color: #cbd5f5;
      }

      #reset-view-widget {
        min-height: 44px;
      }
    </style>
    <script src="vendor/deck.gl@9.2.2/deck.gl.min.js"></script>
    <script src="vendor/deck.gl-widgets@9.2.2/deck.gl-widgets.min.js"></script>
    <script>
      (function ensureWidgetNamespace() {
        const mergeWidgets = () => {
          if (!window.deck || !window.deckWidgets) {
            return;
          }

          window.deck.widgets = {
            ...(window.deck.widgets || {}),
            ...window.deckWidgets,
          };
        };

        mergeWidgets();
        window.addEventListener("load", mergeWidgets, { once: true });
      })();
    </script>
  </head>
  <body>
    <div id="app">
      <div id="deck-canvas" aria-label="deck.gl polygon example"></div>
      <div id="control-panel">
        <h1>PolygonLayer Extrusion</h1>
        <p>
          A deck.gl PolygonLayer rendering San Francisco zip code polygons with
          heights derived from population density.
        </p>
        <div id="reset-view-widget"></div>
      </div>
    </div>
    <script>
      (function initDeck() {
        const {
          Deck,
          MapView,
          PolygonLayer,
          COORDINATE_SYSTEM,
          AmbientLight,
          PointLight,
          LightingEffect,
        } = deck;

        const INITIAL_VIEW_STATE = {
          longitude: -122.45,
          latitude: 37.8,
          zoom: 11,
          minZoom: 5,
          maxZoom: 16,
          pitch: 45,
          bearing: 0,
        };

        const lights = new LightingEffect({
          ambientLight: new AmbientLight({
            color: [255, 255, 255],
            intensity: 0.5,
          }),
          pointLight1: new PointLight({
            color: [255, 255, 255],
            intensity: 1,
            position: [-122.45, 37.8, 8000],
          }),
          pointLight2: new PointLight({
            color: [255, 255, 255],
            intensity: 0.6,
            position: [-122.35, 37.85, 5000],
          }),
        });

        const colorScale = (density) => {
          if (!Number.isFinite(density)) {
            return [148, 163, 184, 180];
          }

          if (density > 5000) return [248, 113, 113, 255];
          if (density > 3000) return [251, 191, 36, 255];
          if (density > 1500) return [52, 211, 153, 255];
          return [96, 165, 250, 255];
        };

        const layer = new PolygonLayer({
          id: "population-density",
          data: "https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/sf-zipcodes.json",
          pickable: true,
          stroked: true,
          filled: true,
          extruded: true,
          wireframe: true,
          lineWidthMinPixels: 1,
          getPolygon: (f) => f.contour,
          getElevation: (f) =>
            (f.properties.population / f.properties.area) * 10,
          getFillColor: (f) =>
            colorScale(f.properties.population / f.properties.area),
          getLineColor: [30, 41, 59],
          material: true,
          parameters: {
            depthTest: true,
          },
          coordinateSystem: COORDINATE_SYSTEM.LNGLAT,
        });

        const tooltip = ({ object }) => {
          if (!object) return null;
          const { zipcode, population, area } = object.properties;
          const density = population / area;
          return {
            html: `
              <div><strong>ZIP code:</strong> ${zipcode}</div>
              <div><strong>Population:</strong> ${population.toLocaleString()}</div>
              <div><strong>Area:</strong> ${area.toFixed(2)} km²</div>
              <div><strong>Density:</strong> ${density.toFixed(0)} per km²</div>
            `,
          };
        };

        const deckInstance = new Deck({
          container: "deck-canvas",
          views: [new MapView({ id: "main-map" })],
          controller: true,
          initialViewState: INITIAL_VIEW_STATE,
          layers: [layer],
          getTooltip: tooltip,
          effects: [lights],
        });

        const widgetContainer = document.getElementById("reset-view-widget");

        const createResetWidget = () => {
          const widgetsNamespace = deck.widgets;
          if (!widgetsNamespace || !widgetsNamespace.ResetViewWidget) {
            console.warn("ResetViewWidget is unavailable");
            return null;
          }

          return new widgetsNamespace.ResetViewWidget({
            container: widgetContainer,
            onReset: () => {
              deckInstance.setProps({ viewState: { ...INITIAL_VIEW_STATE } });
              // Clear viewState override to resume controller-driven updates
              deckInstance.setProps({ viewState: null });
            },
          });
        };

        const attachResetWidget = () => {
          const resetWidget = createResetWidget();
          if (!resetWidget) {
            return;
          }

          deckInstance.setProps({ widgets: [resetWidget] });
        };

        if (document.readyState === "complete") {
          attachResetWidget();
        } else {
          window.addEventListener("load", attachResetWidget, { once: true });
        }
      })();
    </script>
  </body>
</html>
