<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>deck.gl GeoJsonLayer (polygons) example</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="vendor/deck.gl-widgets@9.2.2/deck.gl-widgets.min.css"
    />
    <style>
      :root {
        color-scheme: dark;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        background: #020617;
        color: #f8fafc;
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
      }

      #app {
        position: relative;
        height: 100%;
        width: 100%;
      }

      #deck-container {
        position: absolute;
        inset: 0;
      }

      #control-panel {
        position: absolute;
        top: 16px;
        left: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px 18px;
        width: min(320px, 90vw);
        background: rgba(2, 6, 23, 0.84);
        border-radius: 12px;
        backdrop-filter: blur(6px);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.4);
        z-index: 5;
      }

      #control-panel h1 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }

      #control-panel p {
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.45;
        color: #cbd5f5;
      }

      #widget-container {
        display: flex;
        gap: 12px;
      }

      .deck-widget {
        --deck-widget-control-bg: rgba(15, 23, 42, 0.9);
        --deck-widget-control-color: #f8fafc;
        --deck-widget-control-border: rgba(148, 163, 184, 0.2);
      }
    </style>
    <script
      src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"
      integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb"
      crossorigin="anonymous"
    ></script>
    <script>
      window.mapboxgl = window.maplibregl;
    </script>
    <script src="vendor/deck.gl@9.2.2/deck.gl.min.js"></script>
    <script src="vendor/deck.gl-widgets@9.2.2/deck.gl-widgets.min.js"></script>
    <script>
      (function bridgeWidgetNamespace() {
        const connect = () => {
          if (!window.deck || !window.deckWidgets) {
            return;
          }

          window.deck.widgets = {
            ...(window.deck.widgets || {}),
            ...window.deckWidgets,
          };
        };

        connect();
        window.addEventListener("load", connect, { once: true });
      })();
    </script>
  </head>
  <body>
    <div id="app">
      <div
        id="deck-container"
        aria-label="deck.gl GeoJsonLayer polygons example"
      ></div>
      <div id="control-panel">
        <h1>GeoJsonLayer (polygons)</h1>
        <p>
          Vancouver block polygons extruded by value per square metre, rendered
          with deck.gl&apos;s GeoJsonLayer example configuration.
        </p>
        <div id="widget-container"></div>
      </div>
    </div>
    <script>
      (function main() {
        const MAP_STYLE =
          "https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json";
        const DATA_URL =
          "https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/geojson/vancouver-blocks.json";

        const INITIAL_VIEW_STATE = {
          latitude: 49.254,
          longitude: -123.13,
          zoom: 11,
          maxZoom: 16,
          pitch: 45,
          bearing: 0,
        };

        const buildWidgets = () => {
          const widgetsNamespace = deck.widgets;
          if (!widgetsNamespace) {
            return [];
          }

          const instances = [];
          if (widgetsNamespace.ZoomWidget) {
            instances.push(
              new widgetsNamespace.ZoomWidget({
                container: document.getElementById("widget-container"),
              }),
            );
          }

          if (widgetsNamespace.CompassWidget) {
            instances.push(
              new widgetsNamespace.CompassWidget({
                container: document.getElementById("widget-container"),
              }),
            );
          }

          return instances;
        };

        const deckProps = {
          container: "deck-container",
          controller: true,
          initialViewState: INITIAL_VIEW_STATE,
          views: [
            new deck.MapView({
              controller: true,
              mapStyle: MAP_STYLE,
            }),
          ],
          layers: [
            new deck.GeoJsonLayer({
              id: "vancouver-blocks",
              data: DATA_URL,
              opacity: 0.8,
              stroked: false,
              filled: true,
              extruded: true,
              wireframe: true,
              elevationScale: 0.1,
              getElevation: (feature) => feature.properties.valuePerSqm,
              getFillColor: [199, 233, 180],
              getLineColor: [255, 255, 255],
            }),
          ],
        };

        const widgets = buildWidgets();
        if (widgets.length > 0) {
          deckProps.widgets = widgets;
        }

        const deckInstance = new deck.Deck(deckProps);

        if (widgets.length === 0) {
          window.addEventListener(
            "load",
            () => {
              const lateWidgets = buildWidgets();
              if (lateWidgets.length > 0) {
                deckInstance.setProps({ widgets: lateWidgets });
              }
            },
            { once: true },
          );
        }
      })();
    </script>
  </body>
</html>
